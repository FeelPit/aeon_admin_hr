#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä—è–º–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ —á–µ—Ä–µ–∑ –ø—É–±–ª–∏—á–Ω—ã–π IP

echo "üöÄ –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å –ø—Ä—è–º—ã–º –¥–æ—Å—Ç—É–ø–æ–º..."

# –ü–æ–ª—É—á–∞–µ–º –ø—É–±–ª–∏—á–Ω—ã–π IP
PUBLIC_IP=$(curl -s ifconfig.me)
echo "üåê –í–∞—à –ø—É–±–ª–∏—á–Ω—ã–π IP: $PUBLIC_IP"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Ä–∞–±–æ—Ç–∞–µ—Ç –ª–∏ backend
echo "üì° –ü—Ä–æ–≤–µ—Ä–∫–∞ backend..."
if ! curl -s http://localhost:8001/api/health > /dev/null; then
    echo "‚ùå Backend –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –ø–æ—Ä—Ç—É 8001"
    echo "–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–Ω–∞—á–∞–ª–∞: ./start-backend.sh"
    exit 1
fi

echo "‚úÖ Backend —Ä–∞–±–æ—Ç–∞–µ—Ç"

# –ó–∞–ø—É—Å–∫–∞–µ–º backend –Ω–∞ –≤—Å–µ—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞—Ö
echo "üì¶ –ó–∞–ø—É—Å–∫ backend –Ω–∞ –≤—Å–µ—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞—Ö..."
cd backend
python3 -m uvicorn main:app --host 0.0.0.0 --port 8001 --reload &
BACKEND_PID=$!

# –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ, —á—Ç–æ–±—ã backend –∑–∞–ø—É—Å—Ç–∏–ª—Å—è
sleep 3

echo ""
echo "üéâ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ!"
echo ""
echo "üì± –õ–æ–∫–∞–ª—å–Ω—ã–π –¥–æ—Å—Ç—É–ø:"
echo "   http://localhost:8001"
echo "   http://127.0.0.1:8001"
echo ""
echo "üåê –í–Ω–µ—à–Ω–∏–π –¥–æ—Å—Ç—É–ø (–µ—Å–ª–∏ –ø–æ—Ä—Ç 8001 –æ—Ç–∫—Ä—ã—Ç –≤ —Ñ–∞–π—Ä–≤–æ–ª–µ):"
echo "   http://$PUBLIC_IP:8001"
echo ""
echo "üìä API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:"
echo "   http://localhost:8001/docs"
echo "   http://$PUBLIC_IP:8001/docs"
echo ""
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è:"
echo "   http://localhost:8001/api/health"
echo "   http://$PUBLIC_IP:8001/api/health"
echo ""
echo "‚ö†Ô∏è  –í–∞–∂–Ω–æ:"
echo "   - –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–æ—Ä—Ç 8001 –æ—Ç–∫—Ä—ã—Ç –≤ —Ñ–∞–π—Ä–≤–æ–ª–µ"
echo "   - –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø—Ä–æ–±—Ä–æ—Å –ø–æ—Ä—Ç–∞ –≤ —Ä–æ—É—Ç–µ—Ä–µ, –µ—Å–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ"
echo "   - –î–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å VPN –∏–ª–∏ SSH —Ç—É–Ω–Ω–µ–ª—å"
echo ""
echo "üõë –î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞–∂–º–∏—Ç–µ Ctrl+C"

# –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏
trap "kill $BACKEND_PID 2>/dev/null" EXIT

# –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
wait 